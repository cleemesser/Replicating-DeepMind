"""

Preprocessor takes images from ALE and turns them into cropped, downscaled arrays of grayscale values.

"""

from PIL import Image
import numpy as np


class Preprocessor:

    grayscale_array = None
    desired_image_size = 84         # the size of the new image will be desired_image_size x desired_image_size

    def __init__(self):
        """
        Initialise preprocessor
        """
        self.grayscale_array = self.get_grayscale_array()

    def process(self, image_string):
        """
        Returns the cropped, downscaled, grayscale array representation of the image.
        @param image_string: a string that ALE outputs, corresponding to a 160x210 color image
        """
        arr = self.grayscale_array

        # Crop irrelevant lines from beginning and end
        cropped = image_string[160*33*2:160*193*2]

        # Split cropped image string into a list of hex codes
        hexs = [cropped[i*2:i*2+2] for i in range(len(cropped)/2)]

        # Map each element of the list to the corresponding gray value
        grays = np.asarray(map(lambda hex_val: arr[int(hex_val[1], 16) ,int(hex_val[0], 16)], hexs))

        # Turn the array into an image object and downscale
        img = Image.fromarray(grays.reshape((160, 160)))
        new_size = self.desired_image_size, self.desired_image_size
        img.thumbnail(new_size)

        # Get pixel data again
        raw_pixels = np.asarray(img, dtype=np.uint8)
        return raw_pixels

    def get_grayscale_array(self):
        """
        Returns the (numpy) array that is used for mapping NTSC colors to grayscale values
        """
        
        return np.array(
            [
                [
                    0.000000000000000000e00,
                    6.256000000000000227e01,
                    5.192000000000000171e01,
                    4.475999999999999801e01,
                    2.855999999999999872e01,
                    3.164000000000000057e01,
                    2.351999999999999957e01,
                    1.344000000000000128e01,
                    9.520000000000001350e00,
                    2.571999999999999886e01,
                    3.767999999999999972e01,
                    4.567999999999999261e01,
                    4.259999999999999432e01,
                    4.396000000000000085e01,
                    4.332000000000000028e01,
                    4.267999999999999972e01,
                ],
                [
                    6.335999999999999943e01,
                    9.312000000000000455e01,
                    7.740000000000000568e01,
                    7.052000000000001023e01,
                    5.771999999999999886e01,
                    6.023999999999999488e01,
                    5.295999999999999375e01,
                    4.343999999999999773e01,
                    3.951999999999999602e01,
                    5.571999999999999886e01,
                    6.823999999999999488e01,
                    7.623999999999999488e01,
                    7.427999999999998693e01,
                    7.819999999999998863e01,
                    7.471999999999998465e01,
                    7.380000000000001137e01,
                ],
                [
                    1.069199999999999875e02,
                    1.239599999999999937e02,
                    1.000399999999999920e02,
                    9.627999999999998693e01,
                    8.376000000000000512e01,
                    8.571999999999998465e01,
                    7.928000000000000114e01,
                    7.059999999999999432e01,
                    6.951999999999999602e01,
                    8.316000000000001080e01,
                    9.568000000000000682e01,
                    1.067999999999999972e02,
                    1.059599999999999937e02,
                    1.087599999999999909e02,
                    1.050000000000000000e02,
                    1.049200000000000017e02,
                ],
                [
                    1.425600000000000023e02,
                    1.508399999999999750e02,
                    1.255199999999999960e02,
                    1.192000000000000028e02,
                    1.089599999999999937e02,
                    1.103599999999999994e02,
                    1.047599999999999909e02,
                    9.775999999999999091e01,
                    9.555999999999998806e01,
                    1.094799999999999898e02,
                    1.225600000000000023e02,
                    1.365199999999999818e02,
                    1.365199999999999818e02,
                    1.361999999999999886e02,
                    1.324399999999999977e02,
                    1.320799999999999841e02,
                ],
                [
                    1.742399999999999807e02,
                    1.737599999999999625e02,
                    1.441999999999999886e02,
                    1.410000000000000000e02,
                    1.310399999999999920e02,
                    1.321599999999999966e02,
                    1.274000000000000057e02,
                    1.201200000000000045e02,
                    1.187600000000000051e02,
                    1.326800000000000068e02,
                    1.460399999999999920e02,
                    1.600000000000000000e02,
                    1.602800000000000011e02,
                    1.627999999999999829e02,
                    1.590399999999999920e02,
                    1.555599999999999739e02,
                ],
                [
                    1.980000000000000000e02,
                    1.969600000000000080e02,
                    1.628799999999999955e02,
                    1.599600000000000080e02,
                    1.531200000000000045e02,
                    1.508400000000000034e02,
                    1.469199999999999875e02,
                    1.433199999999999932e02,
                    1.411200000000000045e02,
                    1.521999999999999886e02,
                    1.686800000000000068e02,
                    1.857599999999999909e02,
                    1.868800000000000239e02,
                    1.862800000000000011e02,
                    1.825200000000000102e02,
                    1.790399999999999920e02,
                ],
                [
                    2.177999999999999829e02,
                    2.198799999999999955e02,
                    1.812800000000000011e02,
                    1.778000000000000114e02,
                    1.743599999999999852e02,
                    1.715199999999999818e02,
                    1.684399999999999977e02,
                    1.654000000000000057e02,
                    1.632000000000000171e02,
                    1.745600000000000023e02,
                    1.913200000000000216e02,
                    2.055600000000000023e02,
                    2.077999999999999829e02,
                    2.097600000000000193e02,
                    2.028799999999999955e02,
                    2.022400000000000091e02,
                ],
                [
                    2.336400000000000148e02,
                    2.391199999999999761e02,
                    1.999600000000000080e02,
                    1.967599999999999909e02,
                    1.933199999999999932e02,
                    1.901999999999999886e02,
                    1.871200000000000045e02,
                    1.849200000000000159e02,
                    1.827199999999999704e02,
                    1.940799999999999841e02,
                    2.111200000000000045e02,
                    2.281999999999999886e02,
                    2.304399999999999977e02,
                    2.323999999999999773e02,
                    2.255199999999999818e02,
                    2.217599999999999909e02,
                ],
            ]
        )
